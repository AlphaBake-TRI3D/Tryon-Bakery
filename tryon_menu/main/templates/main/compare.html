{% extends 'main/base.html' %}

{% block styles %}
<style>
table.table {
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border-radius: 12px;
    overflow: hidden;
}
table.table th, table.table td {
    padding: 16px 12px;
    border-bottom: 1px solid #f0f0f0;
    vertical-align: middle;
}
table.table th {
    background: linear-gradient(90deg, #f8fafc 0%, #e0e7ef 100%);
    color: #222;
    font-weight: 700;
    font-size: 1.1em;
    border-bottom: 2px solid #e0e7ef;
}
table.table tr:last-child td {
    border-bottom: none;
}
table.table tbody tr:hover {
    background: #f3f6fa;
    transition: background 0.2s;
}
table.table img {
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border-radius: 8px;
    border: 1px solid #e0e7ef;
    max-height: 300px;
    cursor: pointer;
}

/* Modal styles */
.img-modal {
    display: none;
    position: fixed !important;
    z-index: 9999 !important;
    left: 0 !important;
    top: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    overflow: auto;
    background: rgba(0,0,0,0.8);
    align-items: center;
    justify-content: center;
    opacity: 0;
    transform: scale(0.8);
    transition: opacity 0.3s ease-out, transform 0.3s ease-out;
}
.img-modal.active {
    display: flex !important;
    opacity: 1;
    transform: scale(1);
}
.img-modal-content {
    max-height: 90vh;
    max-width: 95vw;
    margin: auto;
    display: block;
    border-radius: 12px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.3);
    transform: translateY(20px);
    transition: transform 0.3s ease-out;
}
.img-modal.active .img-modal-content {
    transform: translateY(0);
}
.img-modal-close {
    position: absolute;
    top: 24px;
    right: 36px;
    color: #fff;
    font-size: 2.5rem;
    font-weight: bold;
    cursor: pointer;
    z-index: 1100;
    text-shadow: 0 2px 8px #000;
    opacity: 0;
    transform: scale(0.8);
    transition: opacity 0.3s ease-out, transform 0.3s ease-out;
}
.img-modal.active .img-modal-close {
    opacity: 1;
    transform: scale(1);
}
.modal-images-container {
    display: flex;
    flex-direction: row;
    gap: 20px;
    align-items: flex-start;
    flex-wrap: nowrap;
    max-width: 95vw;
    max-height: 90vh;
}
.modal-image-item {
    flex: 1 1 0;
    text-align: center;
    min-width: 0;
}
.img-modal.active .modal-images-container {
    opacity: 1;
    transform: translateY(0);
}
.modal-image-item h4 {
    color: #fff;
    margin-bottom: 10px;
    font-size: 1.2rem;
    text-shadow: 0 2px 4px #000;
}
.modal-image-item .img-modal-content {
    max-height: 70vh;
    max-width: 100%;
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
}
.modal-row {
    display: flex;
    gap: 20px;
    width: 100%;
    justify-content: center;
}
@media (min-width: 768px) {
    .input-image{
        max-width: 150px;
        max-height: 150px;
    }
}
@media (max-width: 768px) {
    .input-image{
        max-width: 150px;
        max-height: 150px;
    }
    #singleImageModalContent{
        max-height: unset !important;
    }
  .container {
    max-width: 100vw !important;
    width: 100vw !important;
    margin: 0 !important;
    padding: 0 !important;
  }
  .card-body {
    padding-left: 0 !important;
    padding-right: 0 !important;
  }
  .card {
    border-radius: 0 !important;
  }
  table.table, .table.table-bordered {
    width: 100vw !important;
    max-width: 100vw !important;
    min-width: 0 !important;
    table-layout: fixed !important;
    box-shadow: none;
    border-radius: 0;
  }
  table.table th, table.table td {
    width: auto !important;
    max-width: 1px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    padding: 4px 2px;
    font-size: 0.6em;
  }
  table.table img {
    max-width: 100%;
    max-height: 100px;
    height: auto;
    display: block;
    margin: 0 0;
  }
  .is_desktop{
    display: none;
  }
  .modal-images-container {
    flex-wrap: wrap;
    gap: 4px;
    align-items: flex-start;
  }
  .model-output-image-item{
    transform: scale(0.7);
    margin-top: -4em !important;
  }
  .modal-image-item {
    flex: 1 1 38vw;
    max-width: 48vw;
    margin: 0;
    padding: 0;
  }
  .modal-images-container .modal-image-item:nth-child(3) {
    flex-basis: 100vw;
    max-width: 100vw;
  }
  .modal-image-item h4 {
    font-size: 1em;
  }
  .img-modal-content {
    max-width: 100%;
    max-height: 40vw;
    margin: 0 auto;
  }
}
/* Add after existing styles */
.model-image-badge-container {
    position: relative;
    display: inline-block;
}
.model-image-badges {
    /* position: absolute; */
    /* left: 50%; */
    /* bottom: -38px; */
    /* transform: translateX(-50%); */
    display: flex;
    flex-direction: column;
    z-index: 2;
    pointer-events: none;
}
.model-image-badge {
    background: linear-gradient(90deg, #4f8cff 0%, #38e6c5 100%);
    color: #fff;
    font-size: 0.85em;
    font-weight: 600;
    border-radius: 12px;
    padding: 2px 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    border: 1px solid #fff;
    white-space: nowrap;
    opacity: 0.95;
    text-wrap-mode: wrap;
}
.model-image-badge[data-na="true"] {
    background: #b0b0b0;
    color: #fff;
}
.model-image-badge.badge-true {
    background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
    color: #fff;
}
.model-image-badge.badge-false {
    background: linear-gradient(90deg, #ef4444 0%, #b91c1c 100%);
    color: #fff;
}
.model-image-badge.badge-na {
    background: #b0b0b0;
    color: #fff;
}
.badge-selected {
    outline: 2px solid #f59e42;
    background: linear-gradient(90deg, #f59e42 0%, #fbbf24 100%) !important;
    color: #222 !important;
    box-shadow: 0 0 0 2px #fff, 0 2px 8px rgba(0,0,0,0.12);
}
.edit-mode .model-image-badge {
    cursor: pointer;
    opacity: 1 !important;
    filter: none !important;
    pointer-events: auto !important;
    transition: outline 0.2s, background 0.2s;
}
.badge-row {
    display: flex;
    gap: 6px;
    justify-content: center;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="my-4">Comparison</h1>
    {% if user.is_superuser %}
    <div style="margin-bottom: 1em;">
        <label style="font-weight:600;cursor:pointer;">
            <input type="checkbox" id="editModeToggle" style="margin-right:8px;vertical-align:middle;"> Edit Mode
        </label>
        <!-- save button -->
        <button id="saveBadgesBtn" class="btn btn-primary" style="margin-left: 1em;">Save</button>
    </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-body p-0">
            <table class="table table-bordered text-center mb-0">
                <thead>
                    <tr>
                        {% if not is_google %}
                        <th style="width: 10%;">Name</th>
                        {% endif %}
                        <th style="width: 10%;">Garment</th>
                        <th style="width: 10%;">Human</th>
                        
                        <th style="width: 10%;" class="is_desktop"></th>
                        {% if models_list %}
                            {% for model in models_list %}
                                <th>{{ model }}</th>
                            {% endfor %}
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for item in comparisons %}
                    <tr>
                        {% if not is_google %}
                        <td class="align-middle" style="cursor: pointer;" onclick="openAllModelOutputs('{{ item.model_images|join:',' }}', '{{ models_list|join:',' }}')">
                            <strong>{{ item.name }}</strong>
                            </td>
                        {% endif %}
                        <td>
                                <img src="{{ item.garment }}" alt="Garment" class="img-fluid rounded responsive-img input-image" style="max-height: 300px;cursor:pointer;" onclick="handleImageClick('{{ item.garment }}', '{{ item.garment }}', '{{ item.garment }}', '{{ item.human }}', '{{ item.images_alone|join:',' }}', '{{ models_list|join:',' }}', 'garment')">
                                <br>
                                {% if item.garment_type %}
                                    <strong>Garment Type:</strong>
                                    {{ item.garment_type }}
                                {% endif %}
                        </td>
                        <td>
                            <img src="{{ item.human }}" alt="Human" class="img-fluid rounded responsive-img input-image" style="max-height: 300px;cursor:pointer;" onclick="handleImageClick('{{ item.human }}', '{{ item.human }}', '{{ item.garment }}', '{{ item.human }}', '{{ item.images_alone|join:',' }}', '{{ models_list|join:',' }}', 'human')">
                        </td>
                        <td class="is_desktop"></td>
                        {% if item.model_images %}
                            {% for model_image in item.model_images %}
                            <!-- loop index -->
                             {% if model_image.url %}
                                <td>
                                    <div class="model-image-badge-container">
                                        <img src="{{ model_image.url }}" alt="Model output" class="img-fluid rounded responsive-img"  onclick="handleImageClick('{{ model_image.url }}', '{{ model_image.url }}', '{{ item.garment }}', '{{ item.human }}', '{{ item.images_alone|join:',' }}', '{{ models_list|join:',' }}', 'output')">
                                        <div class="model-image-badges">
                                            <div class="badge-row" style="display: flex; gap: 6px; justify-content: center;">
                                                <span class="model-image-badge {% if model_image.garment_realism|default:'N/A' == 'True' %}badge-true{% elif model_image.garment_realism|default:'N/A' == 'False' %}badge-false{% else %}badge-na{% endif %}"
                                                      data-item="{{ item.name }}"
                                                      data-model="{{ model_image.model_name }}"
                                                      data-type="garment_realism">
                                                    Garment Resemblance
                                                </span>
                                                <span class="model-image-badge {% if model_image.body_type_realism|default:'N/A' == 'True' %}badge-true{% elif model_image.body_type_realism|default:'N/A' == 'False' %}badge-false{% else %}badge-na{% endif %}"
                                                      data-item="{{ item.name }}"
                                                      data-model="{{ model_image.model_name }}"
                                                      data-type="body_type_realism">
                                                    Body Shape Resemblance
                                                </span>
                                            </div>
                                            <div class="badge-row" style="display: flex; gap: 6px; justify-content: center; margin-top: 4px;">
                                                <span class="model-image-badge {% if model_image.overall_realism|default:'N/A' == 'True' %}badge-true{% elif model_image.overall_realism|default:'N/A' == 'False' %}badge-false{% else %}badge-na{% endif %}"
                                                      data-item="{{ item.name }}"
                                                      data-model="{{ model_image.model_name }}"
                                                      data-type="overall_realism">
                                                    No Artifacts
                                                </span>
                                                <span class="model-image-badge {% if model_image.face_realism|default:'N/A' == 'True' %}badge-true{% elif model_image.face_realism|default:'N/A' == 'False' %}badge-false{% else %}badge-na{% endif %}"
                                                      data-item="{{ item.name }}"
                                                      data-model="{{ model_image.model_name }}"
                                                      data-type="face_realism">
                                                    Face Resemblance
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            {% else %}

                                <td>
                                    <div class="model-image-badge-container">
                                        <img src="../../static/inputs/no-image-v2.png" alt="Model output" class="img-fluid rounded responsive-img" style="max-width: 220px;max-height: 250px;" >
                                    </div>
                                </td>
                            {% endif %}
                            {% endfor %}
                        {% else %}
                            <td colspan="{{ models_list|length }}">No model images available.</td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="imageModal" class="img-modal" >
    <span class="img-modal-close">&times;</span>
    <div class="modal-images-container" id="modalImagesContainer">
        <div class="modal-image-item">
            <h4>Garment</h4>
            <img class="img-modal-content" id="modalGarment" src="" alt="Garment">
        </div>
        <div class="modal-image-item">
            <h4>Human</h4>
            <img class="img-modal-content" id="modalHuman" src="" alt="Human">
        </div>
        <div class="modal-image-item model-output-image-item">
            <h4 id="modalImageTitle">Model Output</h4>
            <img class="img-modal-content" id="modalImage" src="" alt="Model output">
            <button id="nextModelOutputBtn" style="margin-top: 10px;">Next</button>
        </div>
    </div>
    <!-- model outputs modal -->
    <div id="modelOutputsModal" class="modal-images-container" style="display: none;">
        <div class="modal-image-item">
            <h4 id="modelOutput1Title">Model 1</h4>
            <img class="img-modal-content" id="modelOutput1" src="" alt="Model output 1">
        </div>
        <div class="modal-image-item">
            <h4 id="modelOutput2Title">Model 2</h4>
            <img class="img-modal-content" id="modelOutput2" src="" alt="Model output 2">
        </div>
        <div class="modal-image-item">
            <h4 id="modelOutput3Title">Model 3</h4>
            <img class="img-modal-content" id="modelOutput3" src="" alt="Model output 3">
        </div>
    </div>
    <!-- single image modal -->
    <div id="singleImageModal" class="modal-images-container">
        <img class="img-modal-content" id="singleImageModalContent" src="" alt="Single image">
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Define functions globally first
// Global variables to track model outputs
let modelOutputs = [];
let modelTitles = [];
let currentModelIndex = 0;

function showModelOutput(index) {
    const modalImg = document.getElementById('modalImage');
    const modalImageTitle = document.getElementById('modalImageTitle');
    if (modelOutputs.length > 0) {
        modalImg.src = modelOutputs[index];
        modalImageTitle.textContent = modelTitles.length > index ? modelTitles[index] : `Model Output ${index + 1}`;
    }
}

function openModal(src) {
    const modal = document.getElementById('imageModal');
    const modalImagesContainer = document.getElementById('modalImagesContainer');
    const singleImageModal = document.getElementById('singleImageModal');
    const singleImageModalContent = document.getElementById('singleImageModalContent');

    modal.classList.add('active');
    singleImageModalContent.src = src;
    modalImagesContainer.style.display = 'none';
    singleImageModal.style.display = 'block';
    singleImageModal.classList.add('active');

    singleImageModalContent.src = src;
}

function openModalWithComparison(modelSrc, garmentSrc, humanSrc, allModelOutputsStr = '', allModelTitlesStr = '') {
    // If allModelOutputsStr and allModelTitlesStr are provided, use them; else fallback to single image
    
    if (allModelOutputsStr && allModelTitlesStr && modelSrc == '') {
        modelOutputs = allModelOutputsStr.split(',');
        modelTitles = allModelTitlesStr.split(',');
        currentModelIndex = modelOutputs.indexOf(modelSrc);
        if (currentModelIndex === -1) currentModelIndex = 0;
    } else {
        modelOutputs = [modelSrc];
        modelTitles = ['Model Output'];
        if(allModelOutputsStr && allModelTitlesStr){
            modelOutputs = allModelOutputsStr.split(',');
            modelTitles = allModelTitlesStr.split(',');
            // move modelsrc to the first index
            const modelSrcIndex = modelOutputs.indexOf(modelSrc);
            if (modelSrcIndex !== -1) {
                modelOutputs.unshift(modelOutputs.splice(modelSrcIndex, 1)[0]);
                modelTitles.unshift(modelTitles.splice(modelSrcIndex, 1)[0]);
            }
        }
        currentModelIndex = 0;
    }

    const modal = document.getElementById('imageModal');
    const modalImagesContainer = document.getElementById('modalImagesContainer');
    const singleImageModal = document.getElementById('singleImageModal');
    const modalGarment = document.getElementById('modalGarment');
    const modalHuman = document.getElementById('modalHuman');

    modalImagesContainer.style.display = 'flex';
    singleImageModal.style.display = 'none';

    modal.classList.add('active');
    modalGarment.src = garmentSrc;
    modalHuman.src = humanSrc;

    showModelOutput(currentModelIndex);
}

function openAllModelOutputs(modelImagesStr, modelsStr) {
    console.log("openAllModelOutputs", modelImagesStr, modelsStr);
    // Split comma-separated strings into arrays
    const modelImages = modelImagesStr.split(',');
    const models = modelsStr.split(',');
    const modal = document.getElementById('imageModal');
    const modalImagesContainer = document.getElementById('modalImagesContainer');
    const modelOutputsModal = document.getElementById('modelOutputsModal');
    const singleImageModal = document.getElementById('singleImageModal');
    // Hide other modal containers
    modalImagesContainer.style.display = 'none';
    singleImageModal.style.display = 'none';
    modelOutputsModal.style.display = 'flex';
    // Set model output images and titles
    const modelOutput1 = document.getElementById('modelOutput1');
    const modelOutput2 = document.getElementById('modelOutput2');
    const modelOutput3 = document.getElementById('modelOutput3');
    const modelOutput1Title = document.getElementById('modelOutput1Title');
    const modelOutput2Title = document.getElementById('modelOutput2Title');
    const modelOutput3Title = document.getElementById('modelOutput3Title');
    if (modelImages.length >= 1) {
        modelOutput1.src = modelImages[0];
        modelOutput1Title.textContent = models.length >= 1 ? models[0] : 'Model 1';
    }
    if (modelImages.length >= 2) {
        modelOutput2.src = modelImages[1];
        modelOutput2Title.textContent = models.length >= 2 ? models[1] : 'Model 2';
    }
    if (modelImages.length >= 3) {
        modelOutput3.src = modelImages[2];
        modelOutput3Title.textContent = models.length >= 3 ? models[2] : 'Model 3';
    }
    modal.classList.add('active');
}

function handleImageClicks(self,img, garment, human, modelImages, models, is_output) {
    if (window.innerWidth > 768) {
        openModal(img.src);
    } else {
        console.log(modelImages,models);
        openModalWithComparison('', garment, human, modelImages, models);
    }
}

function handleImageClick(img, modelSrc, garment, human, modelImages, models, value) {
    console.log("handleImageClick called", {img, modelSrc, garment, human, modelImages, models, value});
    if (window.innerWidth > 768) {
        if (value == 'output') {
            console.log("handleModelImageClick", modelImages,'ddddddd');
        openModalWithComparison(modelSrc, garment, human, modelImages, models);
        }else{
            openModal(img);
        }
    } else {
        console.log('value',value);
        if (value != 'output') {
            console.log("handleModelImageClick", modelImages,'ddddddd');
            openModalWithComparison(modelSrc, garment, human, modelImages, models);
        }else {
            openModal(img);
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('imageModal');
    const closeBtn = document.querySelector('.img-modal-close');
    // Next button logic
    const nextBtn = document.getElementById('nextModelOutputBtn');
    if (nextBtn) {
        nextBtn.onclick = function() {
            if (modelOutputs.length > 0) {
                currentModelIndex = (currentModelIndex + 1) % modelOutputs.length;
                showModelOutput(currentModelIndex);
            }
        };
    }
    // Function to close the modal
    function closeModal() {
        modal.classList.remove('active');
        const modalImg = document.getElementById('modalImage');
        const modalGarment = document.getElementById('modalGarment');
        const modalHuman = document.getElementById('modalHuman');
        const modelOutput1 = document.getElementById('modelOutput1');
        const modelOutput2 = document.getElementById('modelOutput2');
        const modelOutput3 = document.getElementById('modelOutput3');
        const singleImageModalContent = document.getElementById('singleImageModalContent');
        // Clear all image sources
        modalImg.src = "";
        modalGarment.src = "";
        modalHuman.src = "";
        modelOutput1.src = "";
        modelOutput2.src = "";
        modelOutput3.src = "";
        singleImageModalContent.src = "";
        // Reset modal displays
        const modalImagesContainer = document.getElementById('modalImagesContainer');
        const modelOutputsModal = document.getElementById('modelOutputsModal');
        const singleImageModal = document.getElementById('singleImageModal');
        modalImagesContainer.style.display = 'none';
        modelOutputsModal.style.display = 'none';
        singleImageModal.style.display = 'none';
    }
    // Assign close events
    closeBtn.onclick = closeModal;
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });
    // --- Edit mode and badge toggling ---
    let editMode = false;
    const editModeToggle = document.getElementById('editModeToggle');
    if (editModeToggle) {
        editModeToggle.addEventListener('change', function() {
            editMode = this.checked;
            document.body.classList.toggle('edit-mode', editMode);
        });
    }
    // Cycle badge state: green (badge-true), red (badge-false), grey (badge-na)
    function cycleBadgeState(badge) {
        if (badge.classList.contains('badge-true')) {
            badge.classList.remove('badge-true');
            badge.classList.add('badge-false');
        } else if (badge.classList.contains('badge-false')) {
            badge.classList.remove('badge-false');
            badge.classList.add('badge-na');
        } else if (badge.classList.contains('badge-na')) {
            badge.classList.remove('badge-na');
            badge.classList.add('badge-true');
        } else {
            // Default to green if no class
            badge.classList.add('badge-true');
        }
    }
    function onBadgeClick(e) {
        if (!editMode) return;
        e.preventDefault();
        cycleBadgeState(this);
    }
    // Add badge click listeners
    document.querySelectorAll('.model-image-badge').forEach(function(badge) {
        badge.addEventListener('click', onBadgeClick);
    });
    const saveBtn = document.getElementById('saveBadgesBtn');
    if (saveBtn) {
        saveBtn.addEventListener('click', function() {
            // Collect all badge states
            const badges = document.querySelectorAll('.model-image-badge');
            const badgeData = {};
            badges.forEach(function(badge) {
                const item = badge.getAttribute('data-item');
                const model = badge.getAttribute('data-model');
                const type = badge.getAttribute('data-type');
                let value = null;
                if (badge.classList.contains('badge-true')) value = true;
                else if (badge.classList.contains('badge-false')) value = false;
                else value = null;
                // skip if the value is null
                if (value === null) return;
                if (!badgeData[item]) badgeData[item] = {};
                if (!badgeData[item][model]) badgeData[item][model] = {};
                badgeData[item][model][type] = value;
            });
            console.log("badgeData", badgeData);
            // Send to backend
            fetch('/save_badges/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(badgeData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Badges saved!');
                } else {
                    alert('Failed to save badges.');
                }
            })
            .catch(() => alert('Error saving badges.'));
        });
    }
    // Helper to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %} 